Bootstrap: docker
From: ghcr.io/bdklahn/jumambar:0.4.0

%setup
    # If our build host has a Github token exported
    # in the following variable, use that to create
    # a file like Docker mounts for build secrets.
    # (to keep this compatible with the Docker build)
    # This is useful if any of the build needs to 
    # log in to private repos (including in the SCIF recipe).
    # See:
    # https://github.com/settings/tokens
    # https://docs.docker.com/build/ci/github-actions/secrets
    [ -z $GITHUB_TOKEN ] ||
    SECRETS_DIR=$APPTAINER_ROOTFS/run/secrets &&
    mkdir -p $SECRETS_DIR &&
    echo $GITHUB_TOKEN > $SECRETS_DIR/github_token

%files
    install_common_R_packages.R /
    install_common_julia_packages.jl /
    epitainer.scif /
    config.json /

%environment
    export TZ=America/New_York
    export SCIDUCT_CONFIG=/scif/data/sciduct/job/config.json
    export JULIA_SCRATCH_TRACK_ACCESS=0

%post
    Rscript /install_common_R_packages.R

    export JULIA_CPU_TARGET="generic;skylake-avx512,clone_all;znver2,clone_all"
    julia /install_common_julia_packages.jl --shared

    micromamba run --name base scif install /epitainer.scif &&
    rm -rf /run/secrets
    # (Don't leave any secret tokens in the container)

%runscript
    exec micromamba run --name base scif "$@"